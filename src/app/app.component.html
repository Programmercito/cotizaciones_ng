<!-- Animated background orbs -->
<div class="bg-orbs" aria-hidden="true">
  <div class="orb orb--1"></div>
  <div class="orb orb--2"></div>
  <div class="orb orb--3"></div>
</div>

<div class="dashboard">
  <!-- Header -->
  <header class="header glass-panel">
    <div class="header__left">
      <div class="header__logo">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                stroke="url(#logoGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="logoGrad" x1="2" y1="2" x2="22" y2="22">
              <stop stop-color="#a78bfa"/>
              <stop offset="1" stop-color="#6366f1"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div>
        <h1 class="header__title">Cotizaciones <span>USDT</span></h1>
        <p class="header__subtitle">Binance P2P &middot; Ultimo mes</p>
      </div>
    </div>
    <div class="header__right">
      <button class="theme-toggle" (click)="toggleTheme()" [attr.aria-label]="theme() === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'">
        @if (theme() === 'dark') {
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/><path d="m12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
          </svg>
        } @else {
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        }
      </button>
      @if (ultimaCotizacion(); as ultima) {
        <div class="header__price-pill">
          <span class="header__price-value">{{ ultima.cotizacion | number:'1.2-2' }}</span>
          <span class="header__price-unit">BOB</span>
        </div>
        <span class="header__live-dot"></span>
      }
    </div>
  </header>

  <!-- Loading state -->
  @if (loading()) {
    <div class="loading glass-panel">
      <div class="loading__ring">
        <div></div><div></div><div></div><div></div>
      </div>
      <p>Cargando cotizaciones...</p>
    </div>
  }

  <!-- Error state -->
  @if (error(); as err) {
    <div class="error-card glass-panel">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <p>{{ err }}</p>
    </div>
  }

  <!-- Content -->
  @if (!loading() && !error()) {
    <!-- Hero price -->
    <section class="hero glass-panel animate-in" style="--delay: 0">
      <div class="hero__left">
        <span class="hero__label">Precio Actual</span>
        <div class="hero__price">
          <span class="hero__currency">BOB</span>
          <span class="hero__amount">{{ ultimaCotizacion()?.cotizacion | number:'1.2-2' }}</span>
        </div>
        <span class="hero__pair">
          1 USDT = {{ ultimaCotizacion()?.cotizacion | number:'1.2-2' }} BOB
          <span class="hero__separator">&middot;</span>
          <svg class="hero__clock" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
          </svg>
          {{ ultimaCotizacion()?.datetime }}
        </span>
      </div>
      <div class="hero__right">
        <div class="hero__variation"
             [class.hero__variation--up]="variacion() >= 0"
             [class.hero__variation--down]="variacion() < 0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            @if (variacion() >= 0) {
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              <polyline points="17 6 23 6 23 12"/>
            } @else {
              <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
              <polyline points="17 18 23 18 23 12"/>
            }
          </svg>
          <span>{{ variacion() >= 0 ? '+' : '' }}{{ variacion() | number:'1.2-4' }}%</span>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card glass-panel animate-in" style="--delay: 1">
        <div class="stat-card__icon stat-card__icon--max">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          </svg>
        </div>
        <span class="stat-card__label">Maximo</span>
        <span class="stat-card__value">{{ cotizacionMax() | number:'1.2-2' }}</span>
      </div>

      <div class="stat-card glass-panel animate-in" style="--delay: 2">
        <div class="stat-card__icon stat-card__icon--min">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
          </svg>
        </div>
        <span class="stat-card__label">Minimo</span>
        <span class="stat-card__value">{{ cotizacionMin() | number:'1.2-2' }}</span>
      </div>

      <div class="stat-card glass-panel animate-in" style="--delay: 3">
        <div class="stat-card__icon stat-card__icon--count">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
          </svg>
        </div>
        <span class="stat-card__label">Registros</span>
        <span class="stat-card__value">{{ cotizaciones().length }}</span>
      </div>

      <div class="stat-card glass-panel animate-in" style="--delay: 4">
        <div class="stat-card__icon stat-card__icon--exchange">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
            <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
          </svg>
        </div>
        <span class="stat-card__label">Exchange</span>
        <span class="stat-card__value stat-card__value--text">{{ ultimaCotizacion()?.exchange }}</span>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-container glass-panel animate-in" style="--delay: 2">
      <div class="chart-container__header">
        <div>
          <h2>Historial de Cotizaciones</h2>
          <p class="chart-container__range">Ultimo mes &middot; {{ cotizaciones().length }} puntos de datos</p>
        </div>
        <div class="chart-container__live">
          <span class="live-pulse"></span>
          En vivo
        </div>
      </div>
      <div class="chart-container__body">
        <canvas #chartCanvas></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container glass-panel animate-in" style="--delay: 3">
      <div class="table-container__header">
        <h2>Registro Detallado</h2>
        <span class="table-container__count">Pagina {{ currentPage() }} de {{ totalPages() }} &middot; {{ cotizacionesTable().length }} entradas</span>
      </div>
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha y Hora</th>
              <th>Moneda</th>
              <th>Cotizacion (BOB)</th>
              <th>Exchange</th>
            </tr>
          </thead>
          <tbody>
            @for (item of cotizacionesPaginated(); track item.datetime; let i = $index) {
              <tr class="animate-row" [style.--row-delay]="i">
                <td class="row-num">{{ pageOffset() + i + 1 }}</td>
                <td>
                  <div class="datetime-cell">
                    <span class="datetime-cell__date">{{ item.datetime.split(' ')[0] }}</span>
                    <span class="datetime-cell__time">{{ item.datetime.split(' ')[1] }}</span>
                  </div>
                </td>
                <td><span class="badge-glow">{{ item.moneda }}</span></td>
                <td class="price">{{ item.cotizacion | number:'1.2-2' }}</td>
                <td><span class="exchange-tag">{{ item.exchange }}</span></td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <button class="pagination__btn pagination__btn--nav"
                  [disabled]="currentPage() === 1"
                  (click)="prevPage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>

          @for (page of visiblePages(); track $index) {
            @if (page === '...') {
              <span class="pagination__ellipsis">&hellip;</span>
            } @else {
              <button class="pagination__btn pagination__btn--page"
                      [class.pagination__btn--active]="page === currentPage()"
                      (click)="goToPage(page)">
                {{ page }}
              </button>
            }
          }

          <button class="pagination__btn pagination__btn--nav"
                  [disabled]="currentPage() === totalPages()"
                  (click)="nextPage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
      }
    </div>

    <!-- Footer -->
    <footer class="footer animate-in" style="--delay: 4">
      <div class="footer__line"></div>
      <p>Datos obtenidos de <strong>Binance P2P</strong> &mdash; Ultima actualizacion: <strong>{{ ultimaCotizacion()?.datetime }}</strong></p>
    </footer>
  }
</div>
